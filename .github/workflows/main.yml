name: Deploy BackendRecetas

on:
  push:
    branches:
    - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
    - name: Checkout c√≥digo
      uses: actions/checkout@v4

    # 1. Generar keystore LOCALMENTE (aqu√≠ s√≠ hay keytool)
    - name: Generar keystore localmente
      run: |
        echo "üîß Generando keystore localmente..."
        mkdir -p src/main/resources
        keytool -genkeypair \
          -alias miapp \
          -keyalg RSA \
          -keysize 2048 \
          -storetype PKCS12 \
          -keystore src/main/resources/keystore.p12 \
          -validity 3650 \
          -storepass TuPasswordSeguro \
          -keypass TuPasswordSeguro \
          -dname "CN=localhost, OU=Dev, O=MiEmpresa, L=Ciudad, S=Estado, C=CL" \
          -noprompt
        echo "‚úÖ Keystore generado localmente"

    # 2. Diagnosticar conexi√≥n SSH
    - name: Diagnosticar conexi√≥n SSH
      uses: appleboy/ssh-action@v1
      with:
        host: ${{ secrets.IP_SERVER }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.PRIVATE_KEY }}
        port: ${{ secrets.PORT }}
        script: |
          echo "üü¢ Conexi√≥n SSH exitosa"
          echo "üêã Docker status:"
          docker --version
          docker-compose --version

    # 3. Sincronizar archivos (INCLUYENDO el keystore generado)s
    - name: Sincronizar archivos al servidor
      uses: burnett01/rsync-deployments@7.0.2
      with:
        switches: "-avz --delete"
        path: "./"
        remote_host: ${{ secrets.IP_SERVER }}
        remote_user: ${{ secrets.USERNAME }}
        remote_path: "/home/ubuntu/backend-recetas/"
        remote_key: ${{ secrets.PRIVATE_KEY }}
        remote_port: ${{ secrets.PORT }}

    # 4. Solo desplegar con Docker Compose
    - name: Desplegar con Docker Compose
      uses: appleboy/ssh-action@v1
      with:
        host: ${{ secrets.IP_SERVER }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.PRIVATE_KEY }}
        port: ${{ secrets.PORT }}
        script_timeout: 5m
        script: |
          cd /home/ubuntu/backend-recetas

          echo "üîç Verificando archivos..."
          ls -la src/main/resources/ || echo "No resources directory"
          ls -la src/main/resources/keystore.p12 && echo "‚úÖ Keystore encontrado" || echo "‚ùå Keystore no encontrado"

          echo "üêã Levantando contenedores..."
          sudo docker-compose down
          sudo docker-compose up -d --build

          echo "‚è∞ Esperando que los servicios inicien..."
          sleep 30

          echo "üîç Verificando contenedores..."
          sudo docker-compose ps
          sudo docker-compose logs --tail=20
          echo "‚úÖ Despliegue completado"
